name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´
      uses: actions/checkout@v3

    - name: ğŸ§° Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
      run: npm install

    - name: âœ… Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹
      run: npm test

    - name: ğŸ³ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
      run: docker build -t quiz-app .

    - name: ğŸš€ Push Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
      run: echo "Push to DockerHub (Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ Ñ‡ĞµÑ€ĞµĞ· Secrets)"
    - name: âœ… Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹
      run: npm test

    - name: ğŸ§¹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°
      run: npm run lint

    - name: ğŸ”’ Security scan (Snyk)
      uses: snyk/actions/node@master
      with:
        command: test
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    - name: ğŸ³ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
      run: docker build -t quiz-app .

    - name: ğŸš€ Push Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker tag quiz-app yourdockerhub/quiz-app:latest
        docker push yourdockerhub/quiz-app:latest
